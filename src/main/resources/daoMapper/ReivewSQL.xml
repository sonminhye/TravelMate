<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="review">

	<insert id="insertReview" parameterType="com.travel.mate.dto.ApplyDTO">
		<![CDATA[
			INSERT INTO
				review (applyCode, content, writeTime)
			VALUES (
				(
				SELECT	a.applyCode
				FROM	apply a
				WHERE	a.travelCode = #{travelCode}
					AND	a.userCode = #{userCode}
				), #{content}, now())
		]]>
	</insert>
	
	<!-- 해당 게시물에 작성된 리뷰 출력 -->
	<select id="selectReviewAll" parameterType="com.travel.mate.dto.ApplyDTO" resultType="hashmap">
		<![CDATA[
			SELECT		ud.name, rr.content, rr.writeTime
			FROM		(
						SELECT	a.userCode, r.content, r.writeTime
						FROM	apply a, review r
						WHERE	a.applyCode = r.applyCode
							AND	a.travelCode = #{travelCode}
						) rr, userDetail ud
			WHERE		rr.userCode = ud.userCode
			ORDER BY	rr.writeTime ASC
		]]>
	</select>
	
	<!-- 로그인한 사람이 해당 게시물에 리뷰 작성했는지 여부 -->
	<select id="selectReviewWrite" parameterType="com.travel.mate.dto.ApplyDTO" resultType="hashmap">
		<![CDATA[
			SELECT	t.travelCode, r.userCode
			FROM	apply a, review r
			WHERE	a.applyCode = r.applyCode
				AND	a.travelCode = #{travelCode}
				AND	r.userCode = #{userCode}	
		]]>
	</select>
	
	<!-- 지금 보고 있는 게시물을 로그인한 사람이 신청했었다면 리뷰창을 보이게 하도록 하기 위함-->
	<select id="selectReviewWriteCheck" parameterType="com.travel.mate.dto.ApplyDTO" resultType="hashmap">
		<![CDATA[
			SELECT	tr.travelCode, a.userCode
			FROM	(
					SELECT	t.travelCode, t.userCode, t.title, t.content, t.writeDate, td.startDate, td.startTime,
							td.endDate, td.endTime, td.minPeople, td.maxPeople
					FROM	travel t, travelDetail td
					WHERE	t.travelCode = td.travelCode
						AND	td.endDate < now()
						AND	t.travelCode = #{travelCode}
					) tr, apply a
			WHERE	tr.travelCode = a.travelCode
				AND a.userCode = #{userCode}
				AND	tr.userCode != a.userCode
		]]>
	</select>
	
</mapper>

