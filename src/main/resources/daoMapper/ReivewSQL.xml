<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="review">

	<insert id="insertReview" parameterType="com.travel.mate.dto.ReviewDTO">
		<![CDATA[
			INSERT INTO
				review (travelCode, userCode, content, writeTime)
			VALUES
				(#{travelCode}, #{userCode}, #{content}, now())
		]]>
	</insert>
	
	<!-- 해당 게시물에 작성된 리뷰 출력 -->
	<select id="selectReviewAll" parameterType="com.travel.mate.dto.ReviewDTO" resultType="hashmap">
		<![CDATA[
			SELECT		ud.name, rr.content, rr.writeTime
			FROM		(
						SELECT		r.userCode, r.content, r.writeTime
						FROM		review r
						WHERE		r.travelCode = #{travelCode}
						) rr, userDetail ud
			WHERE 		rr.userCode = ud.userCode
			ORDER BY	rr.writeTime ASC
		]]>
	</select>
	
	<!-- 해당 게시물에 로그인한 사람이 리뷰 작성했는지 여부 -->
	<select id="selectReviewWrite" parameterType="com.travel.mate.dto.ReviewDTO" resultType="hashmap">
		<![CDATA[
			SELECT	tr.travelCode, tr.userCode
			FROM	(
					SELECT	t.travelCode, r.userCode
					FROM	travel t, review r
					WHERE	t.travelCode = r.travelCode
						AND	t.travelCode = #{travelCode}
						AND	r.userCode = #{userCode}
					) tr, apply a
			WHERE	tr.userCode = a.userCode
				AND	tr.travelCode = a.travelCode
		]]>
	</select>
	
	<!-- 지금 보고 있는 게시물을 로그인한 사람이 신청했었다면 리뷰창을 보이게 하도록 하기 위함-->
	<select id="selectReviewWriteCheck" parameterType="com.travel.mate.dto.ReviewDTO" resultType="hashmap">
		<![CDATA[
			SELECT	tr.travelCode, a.userCode
			FROM	(
					SELECT	t.travelCode, t.userCode, t.title, t.content, t.writeDate, td.startDate, td.startTime,
							td.endDate, td.endTime, td.minPeople, td.maxPeople
					FROM	travel t, travelDetail td
					WHERE	t.travelCode = td.travelCode
						AND	td.endDate < now()
						AND	t.travelCode = #{travelCode}
					) tr, apply a
			WHERE	tr.travelCode = a.travelCode
				AND a.userCode = #{userCode}
				AND	tr.userCode != a.userCode
		]]>
	</select>
	
</mapper>

