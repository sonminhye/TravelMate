<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="travel">

	<!-- 해당 게시물의 신청인원 출력 -->
	<select id="selectTravelApply" parameterType="com.travel.mate.dto.ApplyDTO" resultType="hashmap">
		<![CDATA[
			SELECT	ta.travelCode, ta.userCode
			FROM
					(
					SELECT	t.travelCode, a.userCode
					FROM	travel t, apply a
					WHERE	t.travelCode = a.travelCode
					) ta
			WHERE ta.travelCode = #{travelCode}
				AND ta.userCode = #{userCode}
		]]>
	</select>

	<!-- 첫 화면에 보여질 6개 -->
	<select id="selectTravel" resultType="hashmap">
		<![CDATA[
			SELECT		ts.travelCode, ts.userCode, ts.title, ts.name, ts.writeDate, td.startDate
			FROM
						(
						SELECT		t.travelCode, t.userCode, t.title, ud.name, t.writeDate
						FROM		travel t, userdetail ud
						WHERE		t.userCode = ud.userCode
						) ts, traveldetail td
			WHERE		ts.travelCode = td.travelCode
			ORDER BY	ts.writeDate DESC, ts.travelCode DESC
			LIMIT		0, 6
		]]>
	</select>
	
	<!-- 스크롤을 통해 3개씩 더 가져오기 -->
	<select id="selectTravelScroll" parameterType="int" resultType="hashmap">
		<![CDATA[
			SELECT		ts.travelCode, ts.userCode, ts.title, ts.name, ts.writeDate, td.startDate
			FROM		(
						SELECT		t.travelCode, t.userCode, t.title, ud.name, t.writeDate
						FROM		travel t, userdetail ud
						WHERE		t.userCode = ud.userCode
							AND		t.travelCode <= #{code}
							AND		t.travelCode > #{code} - 3
						) ts, traveldetail td
			WHERE		ts.travelCode = td.travelCode
			ORDER BY	ts.travelCode DESC, ts.writeDate DESC
		]]>
	</select>
	
	<!-- 여행 정보 읽기 -->
	<select id="selectTravelDetail" parameterType="int" resultType="hashmap">
		<![CDATA[
			SELECT	tr.travelCode, tr.userCode, tr.title, tr.content, tr.writeDate, tr.startDate, tr.startTime, tr.endDate, tr.endTime, tr.minPeople, tr.maxPeople, ud.name
			FROM	(
					SELECT	t.travelCode, t.userCode, t.title, t.content, t.writeDate, td.startDate, td.startTime, td.endDate, td.endTime, td.minPeople, td.maxPeople
					FROM	travel t, traveldetail td
					WHERE	t.travelCode = td.travelCode
						AND	t.travelCode = #{code}
					) tr, userdetail ud
			WHERE	tr.userCode = ud.userCode
				
		]]>
	</select>

	<!-- 여행 루트 출력 -->
	<select id="selectTravelRoute" parameterType="int" resultType="hashmap">
		<![CDATA[
			SELECT		tr.lat, tr.lng, tr.location
			FROM		travel t, travelroute tr
			WHERE		t.travelCode = tr.travelCode
				AND		t.travelCode = #{code}
			ORDER BY	tr.location ASC
		]]>
	</select>

	<insert id="insertTravel" parameterType="com.travel.mate.dto.TravelDTO" useGeneratedKeys="true" keyProperty="travelCode">
		<![CDATA[
			INSERT	INTO
				travel (userCode, title, content, writeDate)
			VALUES
				(#{userCode}, #{title}, #{content}, now())
		]]>
	</insert>
	
	<insert id="insertTravelDetail" parameterType="com.travel.mate.dto.TravelDetailDTO">
		<![CDATA[
			INSERT	INTO
				traveldetail (travelCode, startDate, startTime, endDate, endTime, minPeople, maxPeople)
			VALUES
				(#{travelCode}, #{startDate}, #{startTime}, #{endDate}, #{endTime}, #{minPeople}, #{maxPeople})
		]]>
	</insert>

	<insert id="insertTravelRoute" parameterType="com.travel.mate.dto.TravelRouteDTO">
		<![CDATA[
			INSERT	INTO
				travelroute (travelCode, lat, lng, location)
			VALUES
				(#{travelCode}, #{lat}, #{lng}, #{location})
		]]>
	</insert>
	
	<insert id="insertTravelImage" parameterType="com.travel.mate.dto.TravelImageDTO">
		<![CDATA[
			INSERT	INTO
				travelimage (travelCode, image)
			VALUES
				(#{travelCode}, #{image})
		]]>
	</insert>
	
	<insert id="insertTravelApply" parameterType="com.travel.mate.dto.ApplyDTO">
		<![CDATA[
			INSERT	INTO
				apply (travelCode, userCode)
			VALUES
				(#{travelCode}, #{userCode})
		]]>
	</insert>
	
	<delete id="deleteTravelApply" parameterType="com.travel.mate.dto.ApplyDTO">
		<![CDATA[
			DELETE
			FROM	apply
			WHERE	travelCode = #{travelCode}
				AND	userCode = #{userCode}
		]]>
	</delete>
</mapper>

